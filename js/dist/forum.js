(()=>{var o={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return o.d(s,{a:s}),s},d:(t,s)=>{for(var e in s)o.o(s,e)&&!o.o(t,e)&&Object.defineProperty(t,e,{enumerable:!0,get:s[e]})},o:(o,t)=>Object.prototype.hasOwnProperty.call(o,t),r:o=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})}},t={};(()=>{"use strict";o.r(t),o.d(t,{extend:()=>q});const s=flarum.core.compat["common/app"];o.n(s)().initializers.add("nodeloc/flarum-ext-read-permission",(function(){console.log("[nodeloc/flarum-ext-read-permission] Hello, forum and admin!")}));const e=flarum.core.compat["forum/app"];var r=o.n(e);const i=flarum.core.compat.extend,n=flarum.core.compat["common/components/Link"];var a=o.n(n);const c=flarum.core.compat["common/helpers/listItems"];var u=o.n(c);const l=flarum.core.compat["common/helpers/highlight"];var d=o.n(l);const p=flarum.core.compat["forum/components/DiscussionListItem"];var f=o.n(p);const h=flarum.core.compat["forum/components/DiscussionPage"];var v=o.n(h);const b=flarum.core.compat["forum/components/Post"];var P=o.n(b);const g=flarum.core.compat["common/extend"],y=flarum.core.compat["common/utils/classList"];var N=o.n(y);const D=flarum.core.compat["forum/components/DiscussionComposer"];var M=o.n(D);function I(o,t){return I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,t){return o.__proto__=t,o},I(o,t)}function _(o,t){o.prototype=Object.create(t.prototype),o.prototype.constructor=o,I(o,t)}const x=flarum.core.compat["common/components/Button"];var w=o.n(x);const L=flarum.core.compat["common/components/Modal"];var B=o.n(L);flarum.core.compat["common/components/Switch"];const G=flarum.core.compat["common/utils/ItemList"];var O=o.n(G);flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/utils/extractText"],flarum.core.compat["common/components/Select"];const R=flarum.core.compat["common/components/Dropdown"];var S=o.n(R);const j=flarum.core.compat["common/helpers/icon"];var A=o.n(j);const T=flarum.core.compat["common/models/Group"];var k=o.n(T),E=function(o){function t(){return o.apply(this,arguments)||this}_(t,o);var s=t.prototype;return s.oninit=function(t){o.prototype.oninit.call(this,t),this.attrs.selectGroup?this.group=this.attrs.selectGroup:this.group=r().store.getById("groups",k().MEMBER_ID)},s.title=function(){return r().translator.trans("nodeloc-read-permission.forum.modal.add_title")},s.className=function(){return"ReadPermissionDiscussionModal Modal--medium"},s.content=function(){return[m("div",{className:"Modal-body"},m("div",{className:"ReadPermissionDiscussionModal-form"},this.fields().toArray()))]},s.fields=function(){var o=this,t=new(O()),s={3:"fas fa-user"};return t.add("readPermission",m("div",{className:"Form-group"},m("label",{className:"label"},r().translator.trans("nodeloc-read-permission.forum.modal.readPermission_placeholder")),m(S(),{label:[A()(this.group.icon()||s[this.group.id()]),"\t",this.group.namePlural()," - ",this.group.data.attributes.readPermission],buttonClassName:"Button Button--danger"},r().store.all("groups").filter((function(o){return 2!=o.id()})).sort((function(o,t){return o.data.attributes.readPermission-t.data.attributes.readPermission})).map((function(t){return w().component({active:o.group.id()===t.id(),icon:t.icon()||s[t.id()],onclick:function(){o.group=t}},[t.namePlural()," - ",t.data.attributes.readPermission])})))),100),t.add("submit",m("div",{className:"Form-group"},w().component({type:"submit",className:"Button Button--primary ReadPermissionModal-SubmitButton",loading:this.loading},r().translator.trans("nodeloc-read-permission.forum.modal.submit"))),-10),t},s.onsubmit=function(o){var t=this;o.preventDefault();var s=this.group;if(null!==s){var e=this.attrs.onsubmit(s);e instanceof Promise?(this.loading=!0,e.then(this.hide.bind(this),(function(o){console.error(o),t.onerror(o),t.loaded()}))):r().modal.close()}},t}(B());const C=flarum.core.compat["components/Modal"];var z=o.n(C);flarum.core.compat["components/Button"];var F=function(o){function t(){return o.apply(this,arguments)||this}_(t,o);var s=t.prototype;return s.oninit=function(t){o.prototype.oninit.call(this,t)},s.className=function(){return"ReadModal Modal--small"},s.title=function(){return m("div",{className:"failedTitle"},app.translator.trans("nodeloc-read-permission.forum.read-failed"))},s.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"modalText"},app.translator.trans("nodeloc-read-permission.forum.read-failed-detail")))},t}(z());const H=flarum.core.compat["common/extenders"];var J=o.n(H);const V=flarum.core.compat["common/models/Discussion"];var Y=o.n(V);const q=[new(J().Model)(Y()).attribute("readPermission")];r().initializers.add("nodeloc/flarum-ext-read-permission",(function(){var o;(o=M()).prototype.addReadPermission=function(){var o=this;r().modal.show(E,{selectGroup:this.composer.fields.selectGroup,onsubmit:function(t){return o.composer.fields.selectGroup=t}})},(0,g.extend)(o.prototype,"headerItems",(function(o){var t;null==(t=this.composer.body)||null==(t=t.attrs)||t.discussion,o.add("readPermission",m("a",{className:"ComposerBody-readPermission",onclick:this.addReadPermission.bind(this)},m("span",{className:N()("readPermissionLabel",!this.composer.fields.selectGroup&&"none")},r().translator.trans("nodeloc-read-permission.forum.composer_discussion."+(this.composer.fields.selectGroup?"edit":"add")+"_readPermission"))),4)})),(0,g.extend)(o.prototype,"data",(function(o){this.composer.fields.selectGroup&&(o.readPermission=this.composer.fields.selectGroup.data.attributes.readPermission)})),(0,i.override)(f().prototype,"mainView",(function(){var o,t=this.attrs.discussion,s=!1;if(t.attribute("readPermission")>0&&(s=!0,(null!=(o=r().session)&&null!=(o=o.user)&&o.isAdmin()||r().session.user===t.user())&&(s=!1),parseInt(r().session.user.attribute("read_permission"))>=t.attribute("readPermission")&&(s=!1)),this.permissionModal=function(o){o.preventDefault(),r().modal.show(F)},s)return m("a",{href:"javacript:void();",onclick:this.permissionModal.bind(this),className:"DiscussionListItem-main"},m("h2",{className:"DiscussionListItem-title"},d()(t.title(),this.highlightRegExp)),m("ul",{className:"DiscussionListItem-info"},u()(this.infoItems().toArray())));var e=this.getJumpTo();return m(a(),{href:r().route.discussion(t,e),className:"DiscussionListItem-main"},m("h2",{className:"DiscussionListItem-title"},d()(t.title(),this.highlightRegExp)),m("ul",{className:"DiscussionListItem-info"},u()(this.infoItems().toArray())))})),(0,i.override)(v().prototype,"view",(function(o){return this.detectPermission=function(){var o=this.discussion;if(o){var t,s=!1;if(o.attribute("readPermission")>0)return s=!0,(null!=(t=r().session)&&null!=(t=t.user)&&t.isAdmin()||r().session.user===o.user())&&(s=!1),parseInt(r().session.user.attribute("read_permission"))>=o.attribute("readPermission")&&(s=!1),s}},this.detectPermission()?m("div",{className:"DiscussionPage"},m("div",{className:"DiscussionPage-discussion"},m("div",{className:"container"},m("p",null,"You have no permission to view this discussion;")))):o()})),(0,i.override)(P().prototype,"view",(function(o){if(this.attrs.post){var t,s=this.attrs.post.discussion(),e=!1;return this.attrs.post.attribute("readPermission")>0&&(e=!0,(null!=(t=r().session)&&null!=(t=t.user)&&t.isAdmin()||r().session.user===s.user())&&(e=!1),parseInt(r().session.user.attribute("read_permission"))>=this.attrs.post.attribute("readPermission")&&(e=!1)),e?"":o()}}))}))})(),module.exports=t})();
//# sourceMappingURL=forum.js.map