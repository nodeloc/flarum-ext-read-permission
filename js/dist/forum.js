(()=>{var o={n:s=>{var t=s&&s.__esModule?()=>s.default:()=>s;return o.d(t,{a:t}),t},d:(s,t)=>{for(var e in t)o.o(t,e)&&!o.o(s,e)&&Object.defineProperty(s,e,{enumerable:!0,get:t[e]})},o:(o,s)=>Object.prototype.hasOwnProperty.call(o,s),r:o=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})}},s={};(()=>{"use strict";o.r(s),o.d(s,{extend:()=>q});const t=flarum.core.compat["common/app"];o.n(t)().initializers.add("nodeloc/flarum-ext-read-permission",(function(){console.log("[nodeloc/flarum-ext-read-permission] Hello, forum and admin!")}));const e=flarum.core.compat["forum/app"];var r=o.n(e);const i=flarum.core.compat.extend,n=flarum.core.compat["common/components/Link"];var a=o.n(n);const c=flarum.core.compat["common/helpers/listItems"];var u=o.n(c);const l=flarum.core.compat["common/helpers/highlight"];var d=o.n(l);const p=flarum.core.compat["forum/components/DiscussionListItem"];var f=o.n(p);const h=flarum.core.compat["forum/components/DiscussionPage"];var v=o.n(h);const b=flarum.core.compat["forum/components/Post"];var P=o.n(b);const g=flarum.core.compat["common/extend"],y=flarum.core.compat["common/utils/classList"];var N=o.n(y);const D=flarum.core.compat["forum/components/DiscussionComposer"];var M=o.n(D);function I(o,s){return I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,s){return o.__proto__=s,o},I(o,s)}function _(o,s){o.prototype=Object.create(s.prototype),o.prototype.constructor=o,I(o,s)}const x=flarum.core.compat["common/components/Button"];var w=o.n(x);const L=flarum.core.compat["common/components/Modal"];var B=o.n(L);flarum.core.compat["common/components/Switch"];const G=flarum.core.compat["common/utils/ItemList"];var O=o.n(G);flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/utils/extractText"],flarum.core.compat["common/components/Select"];const R=flarum.core.compat["common/components/Dropdown"];var S=o.n(R);const j=flarum.core.compat["common/helpers/icon"];var A=o.n(j);const T=flarum.core.compat["common/models/Group"];var k=o.n(T),E=function(o){function s(){return o.apply(this,arguments)||this}_(s,o);var t=s.prototype;return t.oninit=function(s){o.prototype.oninit.call(this,s),this.attrs.selectGroup?this.group=this.attrs.selectGroup:this.group=r().store.getById("groups",k().MEMBER_ID)},t.title=function(){return r().translator.trans("nodeloc-read-permission.forum.modal.add_title")},t.className=function(){return"ReadPermissionDiscussionModal Modal--medium"},t.content=function(){return[m("div",{className:"Modal-body"},m("div",{className:"ReadPermissionDiscussionModal-form"},this.fields().toArray()))]},t.fields=function(){var o=this,s=new(O()),t={3:"fas fa-user"};return s.add("readPermission",m("div",{className:"Form-group"},m("label",{className:"label"},r().translator.trans("nodeloc-read-permission.forum.modal.readPermission_placeholder")),m(S(),{label:[A()(this.group.icon()||t[this.group.id()]),"\t",this.group.namePlural()," - ",this.group.data.attributes.readPermission],buttonClassName:"Button Button--danger"},r().store.all("groups").filter((function(o){return 2!=o.id()})).sort((function(o,s){return o.data.attributes.readPermission-s.data.attributes.readPermission})).map((function(s){return w().component({active:o.group.id()===s.id(),icon:s.icon()||t[s.id()],onclick:function(){o.group=s}},[s.namePlural()," - ",s.data.attributes.readPermission])})))),100),s.add("submit",m("div",{className:"Form-group"},w().component({type:"submit",className:"Button Button--primary ReadPermissionModal-SubmitButton",loading:this.loading},r().translator.trans("nodeloc-read-permission.forum.modal.submit"))),-10),s},t.onsubmit=function(o){var s=this;o.preventDefault();var t=this.group;if(null!==t){var e=this.attrs.onsubmit(t);e instanceof Promise?(this.loading=!0,e.then(this.hide.bind(this),(function(o){console.error(o),s.onerror(o),s.loaded()}))):r().modal.close()}},s}(B());const C=flarum.core.compat["components/Modal"];var z=o.n(C);flarum.core.compat["components/Button"];var F=function(o){function s(s){var t;return(t=o.call(this,s)||this).readPermission=s.attrs.readPermission,t}_(s,o);var t=s.prototype;return t.oninit=function(s){o.prototype.oninit.call(this,s)},t.className=function(){return"ReadModal Modal--small"},t.title=function(){return m("div",{className:"failedTitle"},app.translator.trans("nodeloc-read-permission.forum.read-failed"))},t.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"modalText"},app.translator.trans("nodeloc-read-permission.forum.read-failed-detail"),this.readPermission))},s}(z());const H=flarum.core.compat["common/extenders"];var J=o.n(H);const V=flarum.core.compat["common/models/Discussion"];var Y=o.n(V);const q=[new(J().Model)(Y()).attribute("readPermission")];r().initializers.add("nodeloc/flarum-ext-read-permission",(function(){var o;(o=M()).prototype.addReadPermission=function(){var o=this;r().modal.show(E,{selectGroup:this.composer.fields.selectGroup,onsubmit:function(s){return o.composer.fields.selectGroup=s}})},(0,g.extend)(o.prototype,"headerItems",(function(o){var s;null==(s=this.composer.body)||null==(s=s.attrs)||s.discussion,o.add("readPermission",m("a",{className:"ComposerBody-readPermission",onclick:this.addReadPermission.bind(this)},m("span",{className:N()("readPermissionLabel",!this.composer.fields.selectGroup&&"none")},r().translator.trans("nodeloc-read-permission.forum.composer_discussion."+(this.composer.fields.selectGroup?"edit":"add")+"_readPermission"))),4)})),(0,g.extend)(o.prototype,"data",(function(o){this.composer.fields.selectGroup&&(o.readPermission=this.composer.fields.selectGroup.data.attributes.readPermission)})),(0,i.override)(f().prototype,"mainView",(function(){var o,s,t=this.attrs.discussion,e=!1;if(t.attribute("readPermission")>0&&null!=(o=r().session)&&o.user&&(e=!0,(null!=(s=r().session)&&null!=(s=s.user)&&s.isAdmin()||r().session.user===t.user())&&(e=!1),parseInt(r().session.user.attribute("read_permission"))>=t.attribute("readPermission")&&(e=!1)),this.permissionModal=function(o){o.preventDefault(),r().modal.show(F,{readPermission:t.attribute("readPermission")})},e)return m("a",{href:"javacript:void();",onclick:this.permissionModal.bind(this),className:"DiscussionListItem-main"},m("h2",{className:"DiscussionListItem-title"},d()(t.title(),this.highlightRegExp)),m("ul",{className:"DiscussionListItem-info"},u()(this.infoItems().toArray())));var i=this.getJumpTo();return m(a(),{href:r().route.discussion(t,i),className:"DiscussionListItem-main"},m("h2",{className:"DiscussionListItem-title"},d()(t.title(),this.highlightRegExp)),m("ul",{className:"DiscussionListItem-info"},u()(this.infoItems().toArray())))})),(0,i.override)(v().prototype,"view",(function(o){return this.detectPermission=function(){var o=this.discussion;if(o){var s,t=!1;if(o.attribute("readPermission")>0)return t=!0,(null!=(s=r().session)&&null!=(s=s.user)&&s.isAdmin()||r().session.user===o.user())&&(t=!1),r().session&&r().session.user&&parseInt(r().session.user.attribute("read_permission"))>=o.attribute("readPermission")&&(t=!1),t}},this.detectPermission()?m("div",{className:"DiscussionPage"},m("div",{className:"DiscussionPage-discussion"},m("div",{className:"container"},m("p",null,"You have no permission to view this discussion;")))):o()})),(0,i.override)(P().prototype,"view",(function(o){if(this.attrs.post){var s,t,e=this.attrs.post.discussion(),i=!1;return this.attrs.post.attribute("readPermission")>0&&null!=(s=r().session)&&s.user&&(i=!0,(null!=(t=r().session)&&null!=(t=t.user)&&t.isAdmin()||r().session.user===e.user())&&(i=!1),parseInt(r().session.user.attribute("read_permission"))>=this.attrs.post.attribute("readPermission")&&(i=!1)),i?"":o()}}))}))})(),module.exports=s})();
//# sourceMappingURL=forum.js.map