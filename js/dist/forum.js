(()=>{var o={n:s=>{var e=s&&s.__esModule?()=>s.default:()=>s;return o.d(e,{a:e}),e},d:(s,e)=>{for(var t in e)o.o(e,t)&&!o.o(s,t)&&Object.defineProperty(s,t,{enumerable:!0,get:e[t]})},o:(o,s)=>Object.prototype.hasOwnProperty.call(o,s),r:o=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})}},s={};(()=>{"use strict";o.r(s),o.d(s,{extend:()=>W});const e=flarum.core.compat["common/app"];o.n(e)().initializers.add("nodeloc/flarum-ext-read-permission",(function(){console.log("[nodeloc/flarum-ext-read-permission] Hello, forum and admin!")}));const t=flarum.core.compat["forum/app"];var r=o.n(t);const i=flarum.core.compat.extend,n=flarum.core.compat["common/components/Link"];var a=o.n(n);const c=flarum.core.compat["common/helpers/listItems"];var u=o.n(c);const l=flarum.core.compat["common/helpers/highlight"];var d=o.n(l);const p=flarum.core.compat["forum/components/DiscussionListItem"];var f=o.n(p);const h=flarum.core.compat["forum/components/DiscussionPage"];var v=o.n(h);const P=flarum.core.compat["forum/components/Post"];var b=o.n(P);const g=flarum.core.compat["common/extend"],y=flarum.core.compat["common/components/Badge"];var D=o.n(y);const N=flarum.core.compat["forum/components/DiscussionList"];var x=o.n(N);const M=flarum.core.compat["common/models/Discussion"];var I=o.n(M);const _=flarum.core.compat["common/utils/classList"];var w=o.n(_);const L=flarum.core.compat["forum/components/DiscussionComposer"];var B=o.n(L);function G(o,s){return G=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,s){return o.__proto__=s,o},G(o,s)}function O(o,s){o.prototype=Object.create(s.prototype),o.prototype.constructor=o,G(o,s)}const R=flarum.core.compat["common/components/Button"];var S=o.n(R);const j=flarum.core.compat["common/components/Modal"];var A=o.n(j);flarum.core.compat["common/components/Switch"];const H=flarum.core.compat["common/utils/ItemList"];var T=o.n(H);flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/utils/extractText"],flarum.core.compat["common/components/Select"];const k=flarum.core.compat["common/components/Dropdown"];var E=o.n(k);const C=flarum.core.compat["common/helpers/icon"];var z=o.n(C);const F=flarum.core.compat["common/models/Group"];var q=o.n(F),J=function(o){function s(){return o.apply(this,arguments)||this}O(s,o);var e=s.prototype;return e.oninit=function(s){o.prototype.oninit.call(this,s),this.attrs.selectGroup?this.group=this.attrs.selectGroup:this.group=r().store.getById("groups",q().MEMBER_ID)},e.title=function(){return r().translator.trans("nodeloc-read-permission.forum.modal.add_title")},e.className=function(){return"ReadPermissionDiscussionModal Modal--medium"},e.content=function(){return[m("div",{className:"Modal-body"},m("div",{className:"ReadPermissionDiscussionModal-form"},this.fields().toArray()))]},e.fields=function(){var o=this,s=new(T()),e={3:"fas fa-user"};return s.add("readPermission",m("div",{className:"Form-group"},m("label",{className:"label"},r().translator.trans("nodeloc-read-permission.forum.modal.readPermission_placeholder")),m(E(),{label:[z()(this.group.icon()||e[this.group.id()]),"\t",this.group.namePlural()," - ",this.group.data.attributes.readPermission],buttonClassName:"Button Button--danger"},r().store.all("groups").filter((function(o){return 2!=o.id()})).sort((function(o,s){return o.data.attributes.readPermission-s.data.attributes.readPermission})).map((function(s){return S().component({active:o.group.id()===s.id(),icon:s.icon()||e[s.id()],onclick:function(){o.group=s}},[s.namePlural()," - ",s.data.attributes.readPermission])})))),100),s.add("submit",m("div",{className:"Form-group"},S().component({type:"submit",className:"Button Button--primary ReadPermissionModal-SubmitButton",loading:this.loading},r().translator.trans("nodeloc-read-permission.forum.modal.submit"))),-10),s},e.onsubmit=function(o){var s=this;o.preventDefault();var e=this.group;if(null!==e){var t=this.attrs.onsubmit(e);t instanceof Promise?(this.loading=!0,t.then(this.hide.bind(this),(function(o){console.error(o),s.onerror(o),s.loaded()}))):r().modal.close()}},s}(A());const V=flarum.core.compat["components/Modal"];var K=o.n(V);flarum.core.compat["components/Button"];var Q=function(o){function s(s){var e;return(e=o.call(this,s)||this).readPermission=s.attrs.readPermission,e}O(s,o);var e=s.prototype;return e.oninit=function(s){o.prototype.oninit.call(this,s)},e.className=function(){return"ReadModal Modal--small"},e.title=function(){return m("div",{className:"failedTitle"},app.translator.trans("nodeloc-read-permission.forum.read-failed"))},e.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"modalText"},app.translator.trans("nodeloc-read-permission.forum.read-failed-detail"),this.readPermission))},s}(K());const U=flarum.core.compat["common/extenders"],W=[new(o.n(U)().Model)(I()).attribute("readPermission")];r().initializers.add("nodeloc/flarum-ext-read-permission",(function(){var o;(0,g.extend)(x().prototype,"requestParams",(function(o){o.include.push("firstPost.lottery")})),(0,g.extend)(I().prototype,"badges",(function(o){this.readPermission()>0&&o.add("readPermission",D().component({type:"readPermission",label:r().translator.trans("nodeloc-read-permission.forum.tooltip.badge")+" >= "+this.readPermission(),icon:"fas fa-seedling"}),5)})),(o=B()).prototype.addReadPermission=function(){var o=this;r().modal.show(J,{selectGroup:this.composer.fields.selectGroup,onsubmit:function(s){return o.composer.fields.selectGroup=s}})},(0,g.extend)(o.prototype,"headerItems",(function(o){var s;null==(s=this.composer.body)||null==(s=s.attrs)||s.discussion,o.add("readPermission",m("a",{className:"ComposerBody-readPermission",onclick:this.addReadPermission.bind(this)},m("span",{className:w()("readPermissionLabel",!this.composer.fields.selectGroup&&"none")},r().translator.trans("nodeloc-read-permission.forum.composer_discussion."+(this.composer.fields.selectGroup?"edit":"add")+"_readPermission"))),4)})),(0,g.extend)(o.prototype,"data",(function(o){this.composer.fields.selectGroup&&(o.readPermission=this.composer.fields.selectGroup.data.attributes.readPermission)})),(0,i.override)(f().prototype,"mainView",(function(){var o,s,e=this.attrs.discussion,t=!1;if(e.attribute("readPermission")>0&&null!=(o=r().session)&&o.user&&(t=!0,(null!=(s=r().session)&&null!=(s=s.user)&&s.isAdmin()||r().session.user===e.user())&&(t=!1),parseInt(r().session.user.attribute("read_permission"))>=e.attribute("readPermission")&&(t=!1)),this.permissionModal=function(o){o.preventDefault(),r().modal.show(Q,{readPermission:e.attribute("readPermission")})},t)return m("a",{href:"javacript:void();",onclick:this.permissionModal.bind(this),className:"DiscussionListItem-main"},m("h2",{className:"DiscussionListItem-title"},d()(e.title(),this.highlightRegExp)),m("ul",{className:"DiscussionListItem-info"},u()(this.infoItems().toArray())));var i=this.getJumpTo();return m(a(),{href:r().route.discussion(e,i),className:"DiscussionListItem-main"},m("h2",{className:"DiscussionListItem-title"},d()(e.title(),this.highlightRegExp)),m("ul",{className:"DiscussionListItem-info"},u()(this.infoItems().toArray())))})),(0,i.override)(v().prototype,"view",(function(o){return this.detectPermission=function(){var o=this.discussion;if(o){var s,e=!1;if(o.attribute("readPermission")>0)return e=!0,(null!=(s=r().session)&&null!=(s=s.user)&&s.isAdmin()||r().session.user===o.user())&&(e=!1),r().session&&r().session.user&&parseInt(r().session.user.attribute("read_permission"))>=o.attribute("readPermission")&&(e=!1),e}},this.detectPermission()?m("div",{className:"DiscussionPage"},m("div",{className:"DiscussionPage-discussion"},m("header",{class:"Hero DiscussionHero DiscussionHero--colored text-contrast--dark"},m("div",{class:"container"},m("ul",{class:"DiscussionHero-items"},m("li",{class:"item-title"},m("h1",{class:"DiscussionHero-title"},r().translator.trans("nodeloc-read-permission.forum.low-permission")," 本帖需要权限 >= ",this.discussion.attribute("readPermission"),"."))))))):o()})),(0,i.override)(b().prototype,"view",(function(o){if(this.attrs.post){var s,e=this.attrs.post.discussion(),t=!1;return this.attrs.post.attribute("readPermission")>0&&(t=!0,(null!=(s=r().session)&&null!=(s=s.user)&&s.isAdmin()||r().session.user===e.user())&&(t=!1),r().session&&r().session.user&&parseInt(r().session.user.attribute("read_permission"))>=this.attrs.post.attribute("readPermission")&&(t=!1)),t?r().translator.trans("nodeloc-read-permission.forum.low-permission"):o()}}))}))})(),module.exports=s})();
//# sourceMappingURL=forum.js.map